{{! template-lint-disable attribute-indentation }}
<div class="session-header">
  <span class="title">
    {{#if this.editable}}
      {{#editable-field
        value=this.title
        save=(action "changeTitle")
        close=(action "revertTitleChanges")
        saveOnEnter=true
        closeOnEscape=true
        as |isSaving|
      }}
        <input
          type="text"
          value={{this.title}}
          disabled={{isSaving}}
          oninput={{action (mut this.title) value="target.value"}}
          onkeyup={{action "addErrorDisplayFor" "title"}}
        >
        {{#if (and (v-get this "title" "isInvalid") (is-in this.showErrorsFor "title"))}}
          <span class="validation-error-message">{{v-get this "title" "message"}}</span>
        {{/if}}
      {{/editable-field}}
    {{else}}
      <h3>{{this.session.title}}</h3>
    {{/if}}
  </span>
  <span class ="session-publication">
    {{#if this.editable}}

      {{publish-menu
        title=this.menuTitle
        icon=this.menuIcon
        publicationStatus=this.publicationStatus
        showAsIs=this.showAsIs
        showPublish=this.showPublish
        showReview=this.showReview
        showTbd=this.showTbd
        showUnPublish=this.showUnPublish
        reviewRoute="session.publication_check"
        reviewObject=this.session
        parentObject=(await this.session.course)
        publishTranslation="general.publishSession"
        unPublishTranslation="general.unPublishSession"
        publish=(action "publish")
        publishAsTbd=(action "publishAsTbd")
        unpublish=(action "unpublish")
      }}
    {{else}}
      {{publication-status item=this.session}}
    {{/if}}
  </span>
</div>

<section class="session-overview">
  <div class="last-update">
    {{fa-icon icon="history" title=(t "general.lastUpdate")}}
    {{t "general.lastUpdate"}}:
    {{this.updatedAt}}
  </div>

  <div class="session-overview-header">

    <div class="title">
      {{t "general.overview"}}
    </div>

    <div class="session-overview-actions">
      {{#if (and (is-fulfilled this.showCopy) (await this.showCopy))}}
        {{#link-to "session.copy" this.session class="copy"}}
          {{fa-icon icon="copy" title=(t "general.copySession") fixedWidth=true}}
        {{/link-to}}
      {{/if}}
    </div>
  </div>

  <div class="session-overview-content">
    <div class="sessiontype block">
      <label>{{t "general.sessionType"}}:</label>
      <span>
        {{#if this.editable}}
          {{#editable-field
            value=this.sessionType.title
            save=(action "changeSessionType")
            close=(action "revertSessionTypeChanges")
          }}
            {{one-way-select
              value=this.sessionType.id
              options=this.sortedSessionTypes
              optionTargetPath="id"
              optionLabelPath="title"
              update=(action "setSessionType")
            }}
          {{/editable-field}}
          {{#unless this.sessionType.active}}
            <em>({{t "general.inactive"}})</em>
          {{/unless}}
        {{else}}
          {{this.session.sessionType.title}}
          {{#unless this.sessionType.active}}
            <em>({{t "general.inactive"}})</em>
          {{/unless}}
        {{/if}}
      </span>
    </div>
    {{#if (await this.showSupplemental)}}
      <div class="sessionsupplemental block">
        <label>{{t "general.supplementalCurriculum"}}:</label>
        <span>
          {{#if this.editable}}
            {{toggle-yesno yes=this.session.supplemental toggle=(action "changeSupplemental")}}
          {{else}}
            {{#if this.session.supplemental}}
              <span class="add">{{t "general.yes"}}</span>
            {{else}}
              <span class="remove">{{t "general.no"}}</span>
            {{/if}}
          {{/if}}
        </span>
      </div>
    {{/if}}
    {{#if (await this.showSpecialAttireRequired)}}
      <div class="sessionspecialattire block">
        <label>{{t "general.specialAttireRequired"}}:</label>
        <span>
          {{#if this.editable}}
            {{toggle-yesno
              yes=this.session.attireRequired
              toggle=(action "changeSpecialAttire")
            }}
          {{else}}
            {{#if this.session.attireRequired}}
              <span class="add">{{t "general.yes"}}</span>
            {{else}}
              <span class="remove">{{t "general.no"}}</span>
            {{/if}}
          {{/if}}
        </span>
      </div>
    {{/if}}
    {{#if (await this.showSpecialEquipmentRequired)}}
      <div class="sessionspecialequipment block">
        <label>{{t "general.specialEquipmentRequired"}}:</label>
        <span>
          {{#if this.editable}}
            {{toggle-yesno
              yes=this.session.equipmentRequired
              toggle=(action "changeSpecialEquipment")
            }}
          {{else}}
            {{#if this.session.equipmentRequired}}
              <span class="add">{{t "general.yes"}}</span>
            {{else}}
              <span class="remove">{{t "general.no"}}</span>
            {{/if}}
          {{/if}}
        </span>
      </div>
    {{/if}}
    {{#if (await this.showAttendanceRequired)}}
      <div class="sessionattendancerequired block">
        <label>{{t "general.attendanceRequired"}}:</label>
        <span>
          {{#if this.editable}}
            {{toggle-yesno
              yes=this.session.attendanceRequired
              toggle=(action "changeAttendanceRequired")
            }}
          {{else}}
            {{#if this.session.attendanceRequired}}
              <span class="add">{{t "general.yes"}}</span>
            {{else}}
              <span class="remove">{{t "general.no"}}</span>
            {{/if}}
          {{/if}}
        </span>
      </div>
    {{/if}}
    <hr>
    <div class="independentlearningcontrol block">
      <label>{{t "general.independentLearning"}}:</label>
      <span class="independentlearningcontrol-value">
        {{#if this.editable}}
          {{toggle-yesno
            yes=this.session.isIndependentLearning
            toggle=(action "saveIndependentLearning")
          }}
        {{else}}
          {{#if this.session.isIndependentLearning}}
            <span class="add">{{t "general.yes"}}</span>
          {{else}}
            <span class="remove">{{t "general.no"}}</span>
          {{/if}}
        {{/if}}
      </span>
    </div>
    {{#if this.session.isIndependentLearning}}
      <div class="sessionilmhours block">
        <label>{{t "general.hours"}}:</label>
        <span>
          {{#if this.editable}}
            {{#editable-field
              value=this.hours
              save=(action "changeIlmHours")
              close=(action "revertIlmHoursChanges")
              saveOnEnter=true
              closeOnEscape=true
            as |isSaving|
            }}
              <input
                type="text"
                value={{this.hours}}
                oninput={{action (mut this.hours) value="target.value"}}
                disabled={{isSaving}}
                onkeyup={{action "addErrorDisplayFor" "hours"}}
              >
              {{#if (and (v-get this "hours" "isInvalid") (is-in this.showErrorsFor "hours"))}}
                <span class="validation-error-message">{{v-get this "hours" "message"}}</span>
              {{/if}}
            {{/editable-field}}
          {{else}}
            {{this.session.ilmSession.hours}}&nbsp;
          {{/if}}
        </span>
      </div>
      <div class="sessionilmduedate block {{if this.session.hasPostrequisite "not-applicable"}}">
        <label>{{t "general.dueBy"}}:</label>
        <span>
          {{#if (is-fulfilled this.session.ilmSession)}}
            {{#if this.editable}}
              {{#editable-field
                value=(moment-format this.session.ilmSession.dueDate "L")
                save=(action "changeIlmDueDate")
                close=(action "revertIlmDueDateChanges")
              }}
                {{pikaday-input
                  value=this.dueDate
                  format="L"
                  onSelection=(action (mut this.dueDate))
                  focusOut=(action "addErrorDisplayFor" "dueDate")
                }}
                {{#if (and (v-get this "dueDate" "isInvalid") (is-in this.showErrorsFor "dueDate"))}}
                  <span class="validation-error-message">{{v-get this "dueDate" "message"}}</span>
                {{/if}}
              {{/editable-field}}
            {{else}}
              {{moment-format this.session.ilmSession.dueDate "L"}}
            {{/if}}
          {{/if}}
        </span>
      </div>
    {{/if}}
    {{#if this.features.sessionLinkingAdminUi}}
      <div class="postrequisite block">
        <label>
          {{#if this.session.hasPostrequisite}}
            {{#link-to "session.index" (await this.session.postrequisite.course) (await this.session.postrequisite)}}
              {{fa-icon  icon="external-link-square-alt"}} {{t "general.duePriorTo"}}:
            {{/link-to}}
          {{else}}
            {{t "general.duePriorTo"}}:
          {{/if}}
        </label>
        {{#if this.editable}}
          {{#editable-field
            value=(await this.postRequisiteTitle)
            save=(action "changePostrequisite")
            close=(action "revertPostrequisiteChanges")
          }}
            <select onchange={{action "setPostrequisite" value="target.value"}}>
              <option value="null" selected={{is-empty (await this.session.postrequisite)}}>{{t "general.none"}}</option>
              {{#each (await this.linkablePostrequisites) as |linkablePostrequisite|}}
                <option value={{linkablePostrequisite.id}} selected={{is-equal linkablePostrequisite (await this.session.postrequisite)}}>
                  {{linkablePostrequisite.title}}
                  {{#if (await linkablePostrequisite.firstOfferingDate)}}
                    {{#if linkablePostrequisite.ilmSession}}
                      <strong>{{t "general.ilm"}}: {{t "general.dueBy"}}</strong> {{moment-format (await linkablePostrequisite.firstOfferingDate) "L"}}
                    {{else}}
                      {{moment-format (await linkablePostrequisite.firstOfferingDate) "L LT"}}
                    {{/if}}
                  {{/if}}
                </option>
              {{/each}}
            </select>
          {{/editable-field}}
        {{else}}
          {{#if this.session.hasPostrequisite}}
            {{this.session.postrequisite.title}}
          {{else}}
            {{t "general.none"}}
          {{/if}}
        {{/if}}
      </div>
      <div class="prerequisites block">
        <label>{{t "general.prerequisites"}}:</label>
        {{#if this.session.hasPrerequisites}}
          <span>
            {{#each (await this.session.prerequisites) as |prerequisite|~}}{{#link-to "session.index" (await prerequisite.course) prerequisite}}{{fa-icon  icon="external-link-square-alt"}} {{prerequisite.title}}{{/link-to~}}{{#unless (eq prerequisite this.session.prerequisites.lastObject)}}, {{/unless}}{{~/each}}
          </span>
        {{else}}
          {{t "general.none"}}
        {{/if}}
      </div>
    {{/if}}
    <hr>
    <div class="sessiondescription">
      <label>{{t "general.description"}}:</label>
      <span>
        {{#if this.editable}}
          {{#editable-field
            value=this.description
            save=(action "saveDescription")
            close=(perform this.revertDescriptionChanges)
            renderHtml=true
            isSaveDisabled=(and (v-get this "description" "isInvalid") (is-in this.showErrorsFor "description"))
            clickPrompt=(t "general.clickToEdit")
          }}
            {{html-editor
              content=this.description
              update=(action "changeDescription")
            }}
            {{#if
              (and (v-get this "description" "isInvalid") (is-in this.showErrorsFor "description"))
            }}
              <span class="validation-error-message">{{v-get this "description" "message"}}</span>
            {{/if}}
          {{/editable-field}}
        {{else}}
          {{! template-lint-disable no-triple-curlies}}
          {{{this.description}}}
        {{/if}}
      </span>
    </div>
    <div class="instructional-notes" data-test-instructional-notes>
      <label>{{t "general.instructionalNotes"}}:</label>
      <span>
        {{#if this.editable}}
          {{#editable-field
            value=this.session.instructionalNotes
            save=(perform this.saveInstructionalNotes)
            close=(action "revertInstructionalNotesChanges")
            renderHtml=true
            isSaveDisabled=(and (v-get this "instructionalNotes" "isInvalid") (is-in this.showErrorsFor "instructionalNotes"))
            clickPrompt=(t "general.clickToEdit")
          }}
            {{html-editor
              content=this.instructionalNotes
              update=(action "changeInstructionalNotes")
            }}
            {{#if
              (and (v-get this "instructionalNotes" "isInvalid") (is-in this.showErrorsFor "instructionalNotes"))
            }}
              <span class="validation-error-message">{{v-get this "instructionalNotes" "message"}}</span>
            {{/if}}
          {{/editable-field}}
        {{else}}
          {{! template-lint-disable no-triple-curlies}}
          {{{this.description}}}
        {{/if}}
      </span>
    </div>
    {{#unless this.session.isIndependentLearning}}
      <br>
      <div class="sessionassociatedgroups">
        <label>{{t "general.associatedGroups"}}:</label>
        <span>
          {{#if (is-fulfilled this.session.associatedOfferingLearnerGroups)}}
            <span>
              {{#each (await this.session.associatedOfferingLearnerGroups) as |group|}}
                {{group.title}},
              {{else}}
                {{t "general.none"}}
              {{/each}}
            </span>
          {{else}}
            {{loading-part}}
          {{/if}}
        </span>
      </div>
    {{/unless}}
  </div>
</section>
